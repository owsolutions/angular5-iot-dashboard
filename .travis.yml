matrix:
  include:
    - language: node_js
      node_js:
        - "9"

      branches:
        only:
          - master

      before_script:
        - npm install -g @angular/cli

      cache:
        yarn: true
        directories:
          - $HOME/.yarn-cache
          - node_modules

      dist: trusty
      addons:
        chrome: stable

      before_install:  
      - export CHROME_BIN=/usr/bin/google-chrome
      - export DISPLAY=:99.0
      - sh -e /etc/init.d/xvfb start
      - sudo apt-get update
      - sudo apt-get install -y libappindicator1 fonts-liberation
      - wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
      - sudo dpkg -i google-chrome*.deb
      - sudo sysctl fs.inotify.max_user_watches=524288
      - sudo sysctl fs.inotify.max_queued_events=524288
      - sudo sysctl -p

      script:
        - npm run lint
        - npm run build
        - npm run build:mock
        - npm run ci

    - language: android
      android:
        components:
          - tools

      notifications:
        email: false

      before_install:
        - yes | sdkmanager "platforms;android-26"
      install:
        - nvm install 9
        - npm install
        - npm install -g cordova
        - echo y | android update sdk -u --filter android-22,android-23

      before_deploy:
        # Set up git user name and tag this commit
        - git config --local user.name "TravisBuildAgent"
        - git config --local user.email "travis@travis-ci.org"
        - git tag "$(date +'%Y%m%d%H%M%S')-$(git log --format=%h -1)"
      deploy:
        provider: releases
        api_key: "GITHUB OAUTH TOKEN"
        file: "/home/travis/build/owsolutions/angular5-iot-dashboard/mobile/platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk"
        skip_cleanup: true

      before_script:
        - cordova platform rm android
        - cordova platform add android

      script:
        - cd mobile
        - cordova prepare
        - cordova build android --release -- --ant
        
      release:
        - exit 0  